<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <title>Visor 3D Bhastian - Estrellas Neón</title>

        <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
        <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>

        <style>
            body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; background-color: #111; }
            /* ESTILOS DE INTERFAZ (Sin cambios) */
            #overlay-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, #ffffff 0%, #e0e0e0 100%); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.8s ease-out; }
            #overlay-logo { max-width: 50%; height: auto; margin-bottom: 20px; }
            #loading-text { font-size: 16px; color: #666; animation: blink 1.5s infinite; }
            #start-button { display: none; width: 130px; height: 130px; background: radial-gradient(circle, #d4af37 0%, #b8962e 100%); color: white; border-radius: 50%; border: 4px solid #fff; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 0 20px rgba(212, 175, 55, 0.6); animation: pulse 2s infinite; }
            @keyframes blink { 0%,100% {opacity:1} 50% {opacity:0.5} }
            @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.05);} 100% {transform: scale(1);} }
            .fade-out { opacity: 0; pointer-events: none; }
            #whatsapp-button { display: none; position: fixed; bottom: 20px; left: 20px; z-index: 9998; }
            #whatsapp-button img { width: 50px; height: 50px; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.5)); }
        </style>

        <script>
            // --- SISTEMA DE ESTRELLAS FUGACES NEÓN ---
            AFRAME.registerComponent('shooting-stars-system', {
                schema: {
                    color: { default: '#ff073a' }, 
                    minInterval: { default: 800 }, 
                    maxInterval: { default: 2500 } 
                },
                init: function () {
                    this.isRunning = false;
                    document.querySelector("#start-button").addEventListener('click', () => {
                        this.isRunning = true;
                        this.scheduleNextStar();
                    });
                },
                scheduleNextStar: function () {
                    if (!this.isRunning) return;
                    const delay = Math.random() * (this.data.maxInterval - this.data.minInterval) + this.data.minInterval;
                    setTimeout(() => { this.spawnStar(); this.scheduleNextStar(); }, delay);
                },
                spawnStar: function () {
                    if (!this.el.sceneEl) return;
                    const star = document.createElement('a-entity');
                    const side = Math.random() > 0.5 ? 1 : -1;
                    const startPos = new THREE.Vector3(side * (15 + Math.random() * 10), 10 + Math.random() * 5, -25);
                    const endPos = new THREE.Vector3(-side * (15 + Math.random() * 10), -5 - Math.random() * 5, -25);
                    const length = 5 + Math.random() * 5;
                    
                    star.setAttribute('geometry', { primitive: 'plane', height: length, width: 0.04 });
                    star.setAttribute('material', {
                        shader: 'standard', color: this.data.color, emissive: this.data.color, 
                        emissiveIntensity: 4, transparent: true, opacity: 0.9, blending: 'additive', side: 'double'
                    });
                    star.object3D.position.copy(startPos);
                    star.object3D.lookAt(endPos);
                    star.object3D.rotateX(Math.PI / 2);

                    const duration = 1000 + Math.random() * 1000;
                    star.setAttribute('animation__move', {
                        property: 'position', to: `${endPos.x} ${endPos.y} ${endPos.z}`, dur: duration, easing: 'linear'
                    });
                    star.setAttribute('animation__fade', {
                        property: 'material.opacity', from: 0.9, to: 0, dur: duration * 0.8, delay: duration * 0.2, easing: 'linear'
                    });
                    star.addEventListener('animationcomplete__move', () => {
                        if(star.parentNode) star.parentNode.removeChild(star);
                    });
                    this.el.sceneEl.appendChild(star);
                }
            });

            // --- APP MANAGER ---
            AFRAME.registerComponent('app-manager', { 
                init: function () { 
                    const model = document.querySelector("#animatedModel"); 
                    const overlay = document.querySelector("#overlay-container"); 
                    const loadTxt = document.querySelector("#loading-text"); 
                    const startBtn = document.querySelector("#start-button"); 
                    const audio = document.querySelector("#bg-music"); 
                    const waBtn = document.querySelector("#whatsapp-button"); 
                    
                    model.addEventListener('model-loaded', () => { 
                        loadTxt.style.display = 'none'; 
                        startBtn.style.display = 'block'; 
                    }); 
                    startBtn.addEventListener('click', () => { 
                        overlay.classList.add('fade-out'); 
                        setTimeout(() => { overlay.style.display = 'none'; }, 800); 
                        waBtn.style.display = 'block'; 
                        if(audio) { audio.volume = 1.0; audio.play(); } 
                    }); 
                } 
            });
            
            // NOTA: Se ha eliminado 'model-controller' para usar el sistema nativo de órbita y paneo
        </script>
    </head>

    <body>
        <div id="overlay-container">
            <img id="overlay-logo" src="assets/logo.png" alt="Bhastian">
            <div id="loading-text">Cargando Modelo 3D...</div>
            <button id="start-button">VER<br>EXPERIENCIA</button>
        </div>
        <a href="https://wa.me/593983088889" target="_blank" id="whatsapp-button"><img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp"></a>
        <audio id="bg-music" src="assets/audio.mp3" loop></audio>

        <a-scene 
            app-manager
            shooting-stars-system="color: #ff073a"
            loading-screen="enabled: false" 
            background="color: #080000" 
            renderer="colorManagement: true; antialias: true;"
            vr-mode-ui="enabled: false">
            
            <a-assets>
                <a-asset-item id="modeloGLB" src="assets/tanjirofinal4.glb"></a-asset-item>
            </a-assets>

            <a-light type="ambient" color="#ffffff" intensity="0.8"></a-light>
            <a-light type="directional" position="2 4 5" intensity="1" color="#ffffff"></a-light>
            <a-light type="point" position="0 -5 -5" intensity="0.5" color="#ff0000"></a-light>

            <a-entity 
                camera 
                position="0 1.5 2" 
                orbit-controls="
                    target: 0 0.5 -1; 
                    enableDamping: true; 
                    dampingFactor: 0.1; 
                    rotateSpeed: 0.5; 
                    minDistance: 0.3; 
                    maxDistance: 5;
                    panSpeed: 0.8;
                ">
            </a-entity>

            <a-entity 
                id="animatedModel"
                gltf-model="#modeloGLB"
                position="0 0.5 -1"
                scale="0.012 0.012 0.012"
                rotation="0 0 0"
                animation-mixer="loop: repeat"
            ></a-entity>

        </a-scene>
    </body>
</html>
